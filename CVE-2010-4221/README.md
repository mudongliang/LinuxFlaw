# CVE-2010-4221

## Experiment Environment

Ubuntu 14.04 LTS

## INSTALL & Configuration
```
wget https://github.com/downloads/proftpd/proftpd.github.com/proftpd-1.3.3a.tar.gz

./configure --prefix=`pwd`/build

make

sudo make install

```
## Problems in Installation & Configuration

when `sudo make install` to install executables into designated directory, Make.rules will use `/usr/bin/install` tool with `-s` as option. It will strip symbolic execution from executable. Therefore, you need to delete `-s` option in INSTALL\_SBIN and INSTALL\_BIN to keep symbolic exectution info.

## How to trigger vulnerability

```
sudo gdb ./build/sbin/proftpd 

(gdb) set follow-fork-mode child

(gdb) r
```

while in another terminal
```
python python-exploit.py // for PoC 1 OR
perl poc.pl 127.0.0.1 127.0.0.1 4 // for PoC 2, the last parameter should be specified by platform
```

Now you will see SIGSEG 

## PoCs

[proftpd 1.3.3a exploit](https://github.com/ankh2054/python-exploits/blob/master/protfpd_exploit.py)
[proftpd multiple remote vulnerabilities](http://www.securityfocus.com/bid/44562/exploit)

## Root Cause
```
main.c
pr_cmd_read { // parent function of buggy function (dominator)
	char buf[0x1008]; // stack buffer to be overflowed
	...
	pr_netio_telnet_gets(buf, 0x1007); // call buggy function
	...
}

netio.c
pr_netio_telnet_gets(char* buf, size_t buflen) { // buggy function
	char* bp = buf; // stack buffer to be overflowed
	unsigned char cp;
	...
	pr_buffer_t* pbuf = netio_buffer_alloc(in_nstrm); // pbuf points to input
	...
	while(buflen && *pbuf->current != '\n') { // if buflen = 1 and *pbuf->current != '\n', what will happen ?
		cp = *pbuf->current++;
		switch(telent_mode) {
			case 0xff:
				switch(cp) {
					...
					default: // cp should not be 0xfb, 0xfc, 0xfd, 0xfe, 0xf4, 0xf2
						*bp++ = TELNET_IAC; // stack overflow here
						buflen--; // now buflen = 0
						break;
				}
				break;
			...
			default:
				telnet_mode = cp; // change telnet_mode value to 0xff
			break;
		}
		// finally break to here
		*bp++ = cp; // stack overflow here
		buflen--; // now buflen = -1, integer undeflow here
	}
}

```
## Vulnerability Patch

```
diff -urpN src.orig/netio.c src/netio.c
--- src/netio.c	2017-09-20 14:13:11.268113470 -0700
+++ src.orig/netio.c	2017-09-20 14:13:45.768114288 -0700
@@ -1100,6 +1100,10 @@ char *pr_netio_telnet_gets(char *buf, si
         }
       }
 
+			if (buflen == 0) {
+			break;
+			}
+
       *bp++ = cp;
       buflen--;
     }
```

## References
